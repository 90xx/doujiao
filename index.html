<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èµ„æºæœç´¢</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FlexSearch for fast fuzzy search -->
  <script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.31/dist/flexsearch.bundle.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen py-12 px-4">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ğŸ” èµ„æºæœç´¢</h1>
    
    <input
      id="searchInput"
      type="text"
      placeholder="è¾“å…¥èµ„æºåç§°å…³é”®è¯ï¼ˆå¦‚ï¼šç”·ç¥ä¿±ä¹éƒ¨ï¼‰..."
      class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
    />

    <div id="loading" class="text-center text-gray-500 mt-6">æ­£åœ¨åŠ è½½èµ„æºåº“...</div>
    <div id="results" class="mt-6 space-y-4"></div>
    <div id="noResults" class="text-center text-gray-500 mt-8 hidden">æœªæ‰¾åˆ°ç›¸å…³èµ„æº ğŸ˜¢</div>
  </div>

  <script>
    // === é…ç½® ===
    const STOP_WORDS = ['å°è¯´', 'ç”µè§†', 'å®Œç»“', 'å…¨é›†', 'å®Œæ•´ç‰ˆ', 'é«˜æ¸…', 'ä¸­æ–‡'];

    // ä¸»ç½‘ç›˜å€™é€‰å­—æ®µï¼ˆæŒ‰ä½  data.json ä¸­çš„ keyï¼‰
    const MAIN_CANDIDATES = [
      'wukong', 'quark', 'baidu', 'uc', 'xunlei', 'kuaitu',
      'mobile', 'uc_lanzou', 'baidu_zip', 'mobile_zip', 'xunlei_zip'
    ];

    // å¤‡ç”¨æå–ç å€™é€‰å­—æ®µï¼ˆå®é™…æ˜¯é“¾æ¥ï¼‰
    const BACKUP_CODE_CANDIDATES = [
      'wukong_m', 'quark_m', 'baidu_m', 'ucm',
      'xunlei_m', 'kuaitu_m', 'mobile_m'
    ];

    // === å·¥å…·å‡½æ•° ===
    function cleanQuery(query) {
      let cleaned = query;
      STOP_WORDS.forEach(word => {
        const regex = new RegExp(word, 'g');
        cleaned = cleaned.replace(regex, '');
      });
      return cleaned.trim();
    }

    function getRandomNonEmptyLink(item, fields) {
      const candidates = fields
        .map(field => item[field])
        .filter(url => url && typeof url === 'string' && url.trim() !== '' && url.startsWith('http'));
      if (candidates.length === 0) return null;
      return candidates[Math.floor(Math.random() * candidates.length)];
    }

    // === DOM å…ƒç´  ===
    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('results');
    const loadingDiv = document.getElementById('loading');
    const noResultsDiv = document.getElementById('noResults');

    let resources = [];
    let searchIndex = null;

    // === åŠ è½½ data.json ===
    fetch('./data.json?t=' + Date.now())
      .then(res => {
        if (!res.ok) throw new Error('æ— æ³•åŠ è½½ data.json');
        return res.json();
      })
      .then(data => {
        resources = data;
        searchIndex = new FlexSearch.Document({ id: "id", index: ["title"] });
        resources.forEach(item => searchIndex.add(item));
        loadingDiv.classList.add('hidden');
      })
      .catch(err => {
        loadingDiv.innerHTML = `<p class="text-red-500 text-center">âŒ åŠ è½½å¤±è´¥ï¼š${err.message}<br>è¯·ç¡®ä¿ data.json å­˜åœ¨äºåŒä¸€ç›®å½•</p>`;
        console.error('åŠ è½½é”™è¯¯:', err);
      });

    // === æœç´¢é€»è¾‘ï¼ˆå¸¦é˜²æŠ–ï¼‰===
    function debounce(func, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    const performSearch = debounce((rawQuery) => {
      if (!searchIndex || !rawQuery.trim()) {
        resultsDiv.innerHTML = '';
        noResultsDiv.classList.add('hidden');
        return;
      }

      const query = cleanQuery(rawQuery);
      if (!query) {
        resultsDiv.innerHTML = '<p class="text-gray-500 text-center">è¯·è¾“å…¥æœ‰æ•ˆå…³é”®è¯ï¼ˆå·²å¿½ç•¥â€œå°è¯´â€â€œå®Œç»“â€ç­‰è¯ï¼‰</p>';
        noResultsDiv.classList.add('hidden');
        return;
      }

      const searchResults = searchIndex.search(query, { limit: 50 });
      const hits = searchResults.flatMap(r => r.result)
        .map(id => resources.find(item => item.id === id))
        .filter(Boolean);

      resultsDiv.innerHTML = '';
      noResultsDiv.classList.toggle('hidden', hits.length > 0);

      if (hits.length === 0) {
        noResultsDiv.classList.remove('hidden');
      } else {
        hits.forEach(item => {
          const mainLink = getRandomNonEmptyLink(item, MAIN_CANDIDATES);
          const backupLink = item.lanzou && item.lanzou.startsWith('http') ? item.lanzou : null;
          const backupCodeLink = getRandomNonEmptyLink(item, BACKUP_CODE_CANDIDATES);

          let html = `
            <div class="bg-white p-5 rounded-xl shadow hover:shadow-md transition">
              <h2 class="text-xl font-semibold text-blue-600">${item.title}</h2>
          `;

          if (mainLink) {
            html += `<a href="${mainLink}" target="_blank" rel="noopener noreferrer" class="block mt-2 text-green-600 underline">ğŸ”— ç½‘ç›˜ä¸‹è½½</a>`;
          }

          if (backupLink) {
            html += `<a href="${backupLink}" target="_blank" rel="noopener noreferrer" class="block mt-1 text-purple-600 underline">ğŸ“ å¤‡ç”¨ç½‘ç›˜ï¼ˆè“å¥ï¼‰</a>`;
          }

          if (backupCodeLink) {
            html += `<a href="${backupCodeLink}" target="_blank" rel="noopener noreferrer" class="block mt-1 text-orange-600 underline">ğŸ”‘ å¤‡ç”¨æå–ç é“¾æ¥</a>`;
          }

          html += '</div>';
          resultsDiv.innerHTML += html;
        });
      }
    }, 300);

    searchInput.addEventListener('input', (e) => {
      performSearch(e.target.value);
    });
  </script>
</body>
</html>
