<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Doujiao</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    .search-btn {
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 0.5rem;
    }
    .search-btn:hover {
      background-color: #2563eb;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen py-12 px-4">
  <!-- æ¨¡æ€æ¡†ï¼šè®¿é—®æƒé™éªŒè¯ -->
  <div id="accessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
      <h2 class="text-xl font-bold text-white text-center mb-4 flex items-center justify-center">
        <span class="mr-2">ğŸ”’</span> è·å–ä»Šæ—¥è®¿é—®æƒé™
      </h2>
      <p class="text-gray-300 text-center mb-6">è¯·å‰å¾€æŒ‡å®šä½ç½®è·å–ä»Šæ—¥è®¿é—®ç ï¼š</p>

      <!-- è·å–è®¿é—®ç æŒ‰é’® -->
      <a href="https://your-link-to-get-code.com" target="_blank" rel="noopener noreferrer"
         class="w-full block text-center py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition mb-6 flex items-center justify-center">
        <span class="mr-2">ğŸ‘‰</span> ç‚¹å‡»è·å–ä»Šæ—¥è®¿é—®ç 
      </a>

      <!-- è¾“å…¥æ¡† -->
      <div class="mb-4">
        <label class="block text-gray-300 text-sm mb-2">è¯·è¾“å…¥è·å–åˆ°çš„ 4 ä½è®¿é—®ç ï¼š</label>
        <input
          id="accessCodeInput"
          type="text"
          placeholder="ä¾‹å¦‚: ab12"
          maxlength="4"
          class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <!-- éªŒè¯æŒ‰é’® -->
      <button id="verifyBtn" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition">
        éªŒè¯è®¿é—®ç 
      </button>

      <!-- é”™è¯¯æç¤º -->
      <p id="errorText" class="text-red-500 text-sm mt-4 text-center hidden"></p>
    </div>
  </div>

  <!-- ä¸»é¡µé¢å†…å®¹ -->
  <div class="max-w-3xl mx-auto" id="mainContent">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6 flex items-center justify-center">
      <span class="mr-2">ğŸ”</span> Doujiao
    </h1>

    <div class="flex flex-col md:flex-row gap-2 items-center justify-center">
      <input
        id="searchInput"
        type="text"
        placeholder="è¾“å…¥èµ„æºåç§°..."
        class="w-full md:w-96 px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button class="search-btn">æœç´¢</button>
    </div>

    <div id="loading" class="text-center text-gray-500 mt-6">æ­£åœ¨åŠ è½½èµ„æºåº“...</div>
    <div id="results" class="mt-6 space-y-4"></div>
    <div id="noResults" class="text-center text-gray-500 mt-8 hidden">æœªæ‰¾åˆ°ç›¸å…³èµ„æº ğŸ˜¢</div>
  </div>

  <script>
    // === é…ç½® ===
    const STOP_WORDS = ['å°è¯´', 'ç”µè§†', 'å®Œç»“', 'å…¨é›†', 'å®Œæ•´ç‰ˆ', 'é«˜æ¸…', 'ä¸­æ–‡'];

    const MAIN_CANDIDATES = [
      'wukong', 'quark', 'baidu', 'uc', 'xunlei', 'kuaitu',
      'mobile', 'uc_lanzou', 'baidu_zip', 'mobile_zip', 'xunlei_zip'
    ];

    const BACKUP_CODE_CANDIDATES = [
      'wukong_m', 'quark_m', 'baidu_m', 'ucm',
      'xunlei_m', 'kuaitu_m', 'mobile_m'
    ];

    // âœ… æ¯æ—¥è®¿é—®ç é…ç½®ï¼ˆæ‰‹åŠ¨è®¾ç½®ï¼‰
    const ACCESS_CODES = {
      '2025-12-28': 'ab12',  // ç¤ºä¾‹ï¼šä»Šå¤©æ˜¯ 2025-12-28ï¼Œè®¿é—®ç æ˜¯ ab12
      // '2025-12-29': 'cd34', // å¯ä»¥ç»§ç»­æ·»åŠ æ˜å¤©çš„
    };

    function cleanQuery(query) {
      let cleaned = query;
      STOP_WORDS.forEach(word => {
        const regex = new RegExp(word, 'g');
        cleaned = cleaned.replace(regex, '');
      });
      return cleaned.trim();
    }

    function getRandomNonEmptyLink(item, fields) {
      const candidates = fields
        .map(field => item[field])
        .filter(url => url && typeof url === 'string' && url.trim() !== '' && url.startsWith('http'));
      if (candidates.length === 0) return null;
      return candidates[Math.floor(Math.random() * candidates.length)];
    }

    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('results');
    const loadingDiv = document.getElementById('loading');
    const noResultsDiv = document.getElementById('noResults');
    const mainContent = document.getElementById('mainContent');

    let resources = [];

    // âœ… æ£€æŸ¥æ˜¯å¦éœ€è¦å¼¹å‡ºè®¿é—®ç éªŒè¯
    function showAccessModal() {
      const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
      const lastVerified = localStorage.getItem('lastVerifiedDate');

      // å¦‚æœä»Šå¤©å·²ç»éªŒè¯è¿‡ï¼Œåˆ™ä¸å¼¹
      if (lastVerified === today) return;

      // å¦‚æœæ²¡æœ‰é…ç½®ä»Šå¤©çš„è®¿é—®ç ï¼ŒæŠ¥é”™
      if (!ACCESS_CODES[today]) {
        document.getElementById('errorText').textContent = `ç³»ç»Ÿé”™è¯¯ï¼šæœªé…ç½® ${today} çš„è®¿é—®ç ã€‚`;
        document.getElementById('errorText').classList.remove('hidden');
        return;
      }

      // å¼¹å‡ºæ¨¡æ€æ¡†
      document.getElementById('accessModal').classList.remove('hidden');
    }

    // âœ… éªŒè¯è®¿é—®ç 
    document.getElementById('verifyBtn').addEventListener('click', () => {
      const input = document.getElementById('accessCodeInput').value.trim();
      const today = new Date().toISOString().split('T')[0];
      const expectedCode = ACCESS_CODES[today];

      if (input === expectedCode) {
        // éªŒè¯æˆåŠŸ
        localStorage.setItem('lastVerifiedDate', today);
        document.getElementById('accessModal').classList.add('hidden');
        document.getElementById('errorText').classList.add('hidden');
      } else {
        document.getElementById('errorText').textContent = 'è®¿é—®ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚';
        document.getElementById('errorText').classList.remove('hidden');
      }
    });

    // âœ… é¡µé¢åŠ è½½å®Œæˆæ—¶æ£€æŸ¥
    window.addEventListener('DOMContentLoaded', () => {
      // å…ˆéšè—ä¸»å†…å®¹
      mainContent.classList.add('hidden');

      // æ˜¾ç¤ºè®¿é—®ç å¼¹çª—
      showAccessModal();

      // ç›‘å¬å¼¹çª—å…³é—­åæ¢å¤ä¸»å†…å®¹
      const modal = document.getElementById('accessModal');
      modal.addEventListener('transitionend', () => {
        if (!modal.classList.contains('hidden')) return;
        mainContent.classList.remove('hidden');
      });
    });

    // âœ… åŠ è½½ data.json
    fetch('./data.json?t=' + Date.now())
      .then(res => res.ok ? res.json() : Promise.reject('æ— æ³•åŠ è½½ data.json'))
      .then(data => {
        resources = data;
        loadingDiv.classList.add('hidden');
      })
      .catch(err => {
        loadingDiv.innerHTML = `<p class="text-red-500 text-center">âŒ åŠ è½½å¤±è´¥ï¼š${err}</p>`;
        console.error('åŠ è½½é”™è¯¯:', err);
      });

    // âœ… æœç´¢é€»è¾‘ï¼ˆä¸å˜ï¼‰
    function debounce(func, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    const performSearch = debounce((rawQuery) => {
      if (!resources || !rawQuery.trim()) {
        resultsDiv.innerHTML = '';
        noResultsDiv.classList.add('hidden');
        return;
      }

      const query = cleanQuery(rawQuery);
      if (!query) {
        resultsDiv.innerHTML = '<p class="text-gray-500 text-center">è¯·è¾“å…¥æœ‰æ•ˆå…³é”®è¯</p>';
        noResultsDiv.classList.add('hidden');
        return;
      }

      const hits = resources.filter(item => {
        const title = item.title || '';
        const lowerTitle = title.toLowerCase().replace(/[\s\u2000-\u206F\u2700-\u27BF]/g, '');
        const lowerQuery = query.toLowerCase().replace(/[\s\u2000-\u206F\u2700-\u27BF]/g, '');
        return lowerTitle.includes(lowerQuery);
      });

      resultsDiv.innerHTML = '';
      noResultsDiv.classList.toggle('hidden', hits.length > 0);

      if (hits.length === 0) {
        noResultsDiv.classList.remove('hidden');
      } else {
        hits.forEach(item => {
          const mainLink = getRandomNonEmptyLink(item, MAIN_CANDIDATES);
          const backupLink = item.lanzou && item.lanzou.startsWith('http') ? item.lanzou : null;
          const backupCodeLink = getRandomNonEmptyLink(item, BACKUP_CODE_CANDIDATES);

          let html = `<div class="bg-white p-5 rounded-xl shadow hover:shadow-md transition">
            <h2 class="text-xl font-semibold text-blue-600">${item.title}</h2>`;

          if (mainLink) {
            html += `<a href="${mainLink}" target="_blank" rel="noopener noreferrer" class="block mt-2 text-green-600 no-underline">ğŸ”— ç½‘ç›˜</a>`;
          }

          if (backupLink || backupCodeLink) {
            html += '<div class="border-t border-gray-200 my-3"></div>';
          }

          if (backupLink) {
            html += `<a href="${backupLink}" target="_blank" rel="noopener noreferrer" class="block mt-1 text-orange-600 no-underline">ğŸ”— å¤‡ç”¨ç½‘ç›˜</a>`;
          }

          if (backupCodeLink) {
            html += `<a href="${backupCodeLink}" target="_blank" rel="noopener noreferrer" class="block mt-1 text-orange-600 no-underline">ğŸ”‘ å¤‡ç”¨ç½‘ç›˜æå–ç </a>`;
          }

          html += '</div>';
          resultsDiv.innerHTML += html;
        });
      }
    }, 300);

    // ç»‘å®šäº‹ä»¶
    searchInput.addEventListener('input', (e) => performSearch(e.target.value));
    document.querySelector('.search-btn').addEventListener('click', () => performSearch(searchInput.value));
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch(searchInput.value);
    });
  </script>
</body>
</html>
