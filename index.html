<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Doujiao</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    .search-btn {
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 0.5rem;
    }
    .search-btn:hover {
      background-color: #2563eb;
    }
    .disabled-input {
      background-color: #f9fafb;
      color: #9ca3af;
      cursor: not-allowed;
    }
    .disabled-btn {
      background-color: #d1d5db;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen py-12 px-4">
  <!-- è®¿é—®ç æ¨¡æ€æ¡† -->
  <div id="accessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
      <h2 id="modalTitle" class="text-xl font-bold text-gray-800 text-center mb-4 flex items-center justify-center">
        <span class="mr-2">ğŸ”’</span> æŸ¥çœ‹å®Œæ•´èµ„æºåˆé›†
      </h2>
      <p class="text-gray-600 text-center mb-6">è¯·å‰å¾€æŒ‡å®šä½ç½®è·å–ä»Šæ—¥è®¿é—®ç ï¼š</p>

      <a id="accessLink" href="#" target="_blank" rel="noopener noreferrer"
         class="w-full block text-center py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition mb-6 flex items-center justify-center">
        <span class="mr-2">ğŸ‘‰</span> ç‚¹å‡»è·å– <span id="linkDate">2026-01-05</span> è®¿é—®ç 
      </a>

      <div class="mb-4">
        <label class="block text-gray-700 text-sm mb-2">è¯·è¾“å…¥ 4 ä½è®¿é—®ç ï¼š</label>
        <input
          id="accessCodeInput"
          type="text"
          placeholder="ä¾‹å¦‚: ab12"
          maxlength="4"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <button id="verifyBtn" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition">
        éªŒè¯è®¿é—®ç 
      </button>

      <p id="errorText" class="text-red-500 text-sm mt-4 text-center hidden"></p>
    </div>
  </div>

  <!-- ä¸»å®¹å™¨ï¼šæœç´¢åŒºï¼ˆé»˜è®¤ï¼‰ -->
  <div id="mainContainer" class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6 flex items-center justify-center">
      <span class="mr-2">ğŸ”</span> Doujiao
    </h1>

    <!-- ğŸ‘‹ æ–°äººå¿…çœ‹å…¥å£ -->
    <p class="text-center mb-4">
      <a href="https://www.kdocs.cn/l/cfv01SPXoG7L" target="_blank" rel="noopener noreferrer"
         class="inline-block px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-full shadow hover:shadow-md transition transform hover:-translate-y-0.5">
        ğŸ‘‹ æ–°äººå¿…çœ‹æŒ‡å—
      </a>
    </p>

    <!-- ç±»å‹å¯¼èˆªï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œä½†ç‚¹å‡»éœ€éªŒè¯ï¼‰ -->
    <div id="typeNav" class="text-center mt-4">
      <!-- åŠ¨æ€ç”ŸæˆæŒ‰é’® -->
    </div>

    <div class="flex flex-col md:flex-row gap-2 items-center justify-center mt-4">
      <input
        id="searchInput"
        type="text"
        placeholder="è¾“å…¥èµ„æºåç§°..."
        class="w-full md:w-96 px-4 py-3 border border-gray-300 rounded-lg shadow-sm"
      />
      <button class="search-btn">æœç´¢</button>
    </div>

    <div id="loading" class="text-center text-gray-500 mt-6 hidden">æ­£åœ¨åŠ è½½èµ„æºåº“...</div>
    <div id="results" class="mt-6 space-y-4"></div>
    <div id="noResults" class="text-center text-gray-500 mt-8 hidden">æœªæ‰¾åˆ°ç›¸å…³èµ„æº ğŸ˜¢</div>
  </div>

  <!-- æ¸…å•è§†å›¾ï¼ˆåˆå§‹éšè—ï¼‰ -->
  <div id="listView" class="max-w-4xl mx-auto hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 id="listTitle" class="text-2xl font-bold text-gray-800"></h2>
      <button id="backBtn" class="text-blue-500 hover:underline">â† è¿”å›</button>
    </div>
    <div id="groupedList" class="space-y-6"></div>
    <div id="listPagination" class="mt-8 flex justify-center space-x-2"></div>
  </div>

  <script>
    // === é…ç½® ===
    const STOP_WORDS = ['å°è¯´', 'ç”µè§†', 'å®Œç»“', 'å…¨é›†', 'å®Œæ•´ç‰ˆ', 'é«˜æ¸…', 'ä¸­æ–‡'];
    const NET_DISK_FIELDS = ['kk', 'bd', 'uc', 'xl', 'kt', 'yd', 'wk']; // kk:å¤¸å…‹, bd:ç™¾åº¦, uc:UC, xl:è¿…é›·, kt:å¿«å…”, yd:ç§»åŠ¨, wk:æ‚Ÿç©º

    const ACCESS_MAP = {
      '2026-01-05': { link: 'https://pan.quark.cn/s/c68f0132a97b', code: '8532' },
      '2026-01-06': { link: 'https://pan.quark.cn/s/fbabd589546a', code: '1470' },
      '2026-01-07': { link: 'https://pan.quark.cn/s/1a2c9a75ca2d', code: '7231' },
      '2026-01-08': { link: 'https://pan.quark.cn/s/aa0b8d53620a', code: '2048' },
      '2026-01-09': { link: 'https://pan.quark.cn/s/2da4c170bede', code: '3388' },
      '2026-01-10': { link: 'https://pan.quark.cn/s/ffd272d299ea', code: '7478' },
      '2026-01-11': { link: 'https://pan.quark.cn/s/b6c0fc9d4187', code: '1574' },
      '2026-01-12': { link: 'https://pan.quark.cn/s/031a59f2e250', code: '7865' },
      '2026-01-13': { link: 'https://pan.quark.cn/s/5455ceee2f80', code: '6855' },
      '2026-01-14': { link: 'https://pan.quark.cn/s/412ae569c058', code: '3567' },
      '2026-01-15': { link: 'https://pan.quark.cn/s/7ca20e801c9d', code: '3385' },
      '2026-01-16': { link: 'https://pan.quark.cn/s/9fe9a95bc5f2', code: '1727' },
      '2026-01-17': { link: 'https://pan.quark.cn/s/bb6cd1e53d5b', code: '6721' },
      '2026-01-18': { link: 'https://pan.quark.cn/s/5f17a9a642fb', code: '2824' },
      '2026-01-19': { link: 'https://pan.quark.cn/s/61cf986dfc4b', code: '6344' },
      '2026-01-20': { link: 'https://pan.quark.cn/s/8b0f23aba29c', code: '8340' },
      '2026-01-21': { link: 'https://pan.quark.cn/s/d38ad59e59dd', code: '5558' },
      '2026-01-22': { link: 'https://pan.quark.cn/s/ebfe6725e44b', code: '1637' },
      '2026-01-23': { link: 'https://pan.quark.cn/s/707e11322f75', code: '8600' },
      '2026-01-24': { link: 'https://pan.quark.cn/s/219e178ada01', code: '3876' },
      '2026-01-25': { link: 'https://pan.quark.cn/s/7ee5a0d569f3', code: '3234' },
      '2026-01-26': { link: 'https://pan.quark.cn/s/56f2d33a9d79', code: '5207' }
    };

    // DOM
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.querySelector('.search-btn');
    const loadingDiv = document.getElementById('loading');
    const resultsDiv = document.getElementById('results');
    const noResultsDiv = document.getElementById('noResults');
    const mainContainer = document.getElementById('mainContainer');
    const listView = document.getElementById('listView');
    const typeNav = document.getElementById('typeNav');
    const accessModal = document.getElementById('accessModal');

    let resources = [];
    let currentListType = null;
    const ITEMS_PER_PAGE = 20;

    // å·¥å…·å‡½æ•°ï¼šä»èµ„æºé¡¹ä¸­éšæœºè·å–æœ€å¤š maxCount ä¸ªæœ‰æ•ˆç½‘ç›˜é“¾æ¥
    function getRandomValidLinks(item, maxCount = 3) {
      const urls = NET_DISK_FIELDS
        .map(field => item[field])
        .filter(url => url && typeof url === 'string' && url.trim() !== '' && url.startsWith('http'));
      const uniqueUrls = [...new Set(urls)]; // å»é‡
      const shuffled = uniqueUrls.sort(() => 0.5 - Math.random()); // éšæœºæ‰“ä¹±
      return shuffled.slice(0, maxCount);
    }

    function cleanQuery(query) {
      let cleaned = query;
      STOP_WORDS.forEach(word => {
        const regex = new RegExp(word, 'g');
        cleaned = cleaned.replace(regex, '');
      });
      return cleaned.trim();
    }

    function getBeijingDate() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      const beijingTime = new Date(utc + 8 * 3600000);
      return beijingTime.toLocaleDateString('sv'); // å¦‚ "2025-12-29"
    }

    // === åŠ è½½æ•°æ® ===
    function loadData() {
      if (resources.length > 0) return;
      loadingDiv.classList.remove('hidden');
      fetch('./data.json?t=' + Date.now())
        .then(res => res.ok ? res.json() : Promise.reject('æ— æ³•åŠ è½½ data.json'))
        .then(data => {
          resources = Array.isArray(data) ? data : (data.items || []);
          loadingDiv.classList.add('hidden');
          renderTypeNav();
        })
        .catch(err => {
          loadingDiv.innerHTML = `<p class="text-red-500 text-center">âŒ åŠ è½½å¤±è´¥ï¼š${err}</p>`;
          console.error('åŠ è½½é”™è¯¯:', err);
        });
    }

    // === ç±»å‹å¯¼èˆª ===
    function renderTypeNav() {
      const types = [...new Set(resources.map(item => item.type).filter(t => t))];
      typeNav.innerHTML = '';
      if (types.length === 0) return;

      let html = '<div class="flex flex-wrap justify-center gap-2">';
      types.forEach(type => {
        html += `
          <button data-type="${type}"
                  class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg transition">
             ${type}
          </button>`;
      });
      html += '</div>';
      typeNav.innerHTML = html;

      typeNav.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const type = btn.dataset.type;
          const today = getBeijingDate();
          const lastVerified = localStorage.getItem('lastVerifiedListDate');

          if (lastVerified === today) {
            showListView(type);
          } else {
            const record = ACCESS_MAP[today];
            if (!record) {
              alert(`ç³»ç»Ÿæœªé…ç½® ${today} çš„è®¿é—®ç ï¼Œè¯·ç¨åå†è¯•ã€‚`);
              return;
            }
            document.getElementById('linkDate').textContent = today;
            document.getElementById('accessLink').href = record.link;
            accessModal.style.display = 'flex';
            accessModal.dataset.pendingType = type;
          }
        });
      });
    }

    function showListView(type) {
      currentListType = type;
      document.getElementById('listTitle').textContent = `${type}æ¸…å•`;
      mainContainer.classList.add('hidden');
      listView.classList.remove('hidden');
      renderListPage(1);
    }

    function renderListPage(page) {
      const items = resources.filter(item => item.type === currentListType);
      const groups = {};

      items.forEach(item => {
        const initial = (item.initial || '#').toUpperCase();
        if (!groups[initial]) groups[initial] = [];
        groups[initial].push(item);
      });

      const sortedInitials = Object.keys(groups).sort();
      const allEntries = [];
      sortedInitials.forEach(initial => {
        allEntries.push({ type: 'header', initial });
        groups[initial].forEach(item => allEntries.push({ type: 'item', data: item }));
      });

      const totalPages = Math.ceil(allEntries.length / ITEMS_PER_PAGE);
      const start = (page - 1) * ITEMS_PER_PAGE;
      const pageEntries = allEntries.slice(start, start + ITEMS_PER_PAGE);

      let html = '';
      pageEntries.forEach(entry => {
        if (entry.type === 'header') {
          html += `<h3 class="text-xl font-bold text-gray-700 border-l-4 border-blue-500 pl-2">${entry.initial}</h3>`;
        } else {
          const item = entry.data;
          const links = getRandomValidLinks(item, 3);

          html += `<div class="bg-white p-4 rounded-lg shadow">
            <h4 class="font-semibold text-blue-600">${item.title}</h4>`;

          if (links.length > 0) {
            links.forEach((link, idx) => {
              html += `<a href="${link}" target="_blank" class="block mt-1 text-green-600">ğŸ”— ç½‘ç›˜ ${idx + 1}</a>`;
            });
          } else {
            html += `<p class="text-gray-500 mt-1">æš‚æ— æœ‰æ•ˆé“¾æ¥</p>`;
          }

          html += `</div>`;
        }
      });

      document.getElementById('groupedList').innerHTML = html || '<p class="text-center text-gray-500">æš‚æ— èµ„æº</p>';
      renderPagination(page, totalPages);
    }

    function renderPagination(current, total) {
      const div = document.getElementById('listPagination');
      if (total <= 1) {
        div.classList.add('hidden');
        return;
      }
      div.classList.remove('hidden');

      let html = '';
      const max = 5;
      let start = Math.max(1, current - Math.floor(max / 2));
      let end = Math.min(total, start + max - 1);
      if (end - start + 1 < max) start = Math.max(1, end - max + 1);

      if (current > 1) html += `<button data-page="${current - 1}" class="px-3 py-1 border rounded">â®</button>`;
      for (let i = start; i <= end; i++) {
        html += i === current
          ? `<span class="px-3 py-1 bg-blue-500 text-white rounded">${i}</span>`
          : `<button data-page="${i}" class="px-3 py-1 border rounded">${i}</button>`;
      }
      if (current < total) html += `<button data-page="${current + 1}" class="px-3 py-1 border rounded">â¯</button>`;

      div.innerHTML = html;
      div.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => renderListPage(parseInt(btn.dataset.page)));
      });
    }

    // === è¿”å›æœç´¢ ===
    document.getElementById('backBtn').addEventListener('click', () => {
      listView.classList.add('hidden');
      mainContainer.classList.remove('hidden');
    });

    // === éªŒè¯é€»è¾‘ ===
    document.getElementById('verifyBtn').addEventListener('click', () => {
      const input = document.getElementById('accessCodeInput').value.trim();
      const today = getBeijingDate();
      const record = ACCESS_MAP[today];
      const errorText = document.getElementById('errorText');

      if (!record) {
        errorText.textContent = `ç³»ç»Ÿé”™è¯¯ï¼šæœªé…ç½® ${today} çš„è®¿é—®ç ã€‚`;
        errorText.classList.remove('hidden');
        return;
      }

      if (input === record.code) {
        localStorage.setItem('lastVerifiedListDate', today);
        accessModal.style.display = 'none';
        document.getElementById('accessCodeInput').value = '';
        errorText.classList.add('hidden');

        const pendingType = accessModal.dataset.pendingType;
        if (pendingType) {
          showListView(pendingType);
          delete accessModal.dataset.pendingType;
        }
      } else {
        errorText.textContent = 'è®¿é—®ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚';
        errorText.classList.remove('hidden');
      }
    });

    // === æœç´¢é€»è¾‘ï¼ˆæ— éœ€éªŒè¯ï¼‰===
    function performActualSearch(rawQuery) {
      if (!resources || !rawQuery.trim()) {
        resultsDiv.innerHTML = '';
        noResultsDiv.classList.add('hidden');
        return;
      }

      const query = cleanQuery(rawQuery);
      if (!query) {
        resultsDiv.innerHTML = '<p class="text-gray-500 text-center">è¯·è¾“å…¥æœ‰æ•ˆå…³é”®è¯</p>';
        noResultsDiv.classList.add('hidden');
        return;
      }

      const hits = resources.filter(item => {
        const title = (item.title || '').toLowerCase().replace(/[\s\u2000-\u206F]/g, '');
        const q = query.toLowerCase().replace(/[\s\u2000-\u206F]/g, '');
        return title.includes(q);
      });

      resultsDiv.innerHTML = '';
      noResultsDiv.classList.toggle('hidden', hits.length > 0);

      if (hits.length === 0) {
        noResultsDiv.classList.remove('hidden');
      } else {
        hits.forEach(item => {
          const links = getRandomValidLinks(item, 3);
          let html = `<div class="bg-white p-5 rounded-xl shadow hover:shadow-md transition">
            <h2 class="text-xl font-semibold text-blue-600">${item.title}</h2>`;

          if (links.length > 0) {
            links.forEach((link, idx) => {
              html += `<a href="${link}" target="_blank" class="block mt-2 text-green-600">ğŸ”— ç½‘ç›˜ ${idx + 1}</a>`;
            });
          } else {
            html += `<p class="text-gray-500 mt-2">æš‚æ— æœ‰æ•ˆé“¾æ¥</p>`;
          }

          html += '</div>';
          resultsDiv.innerHTML += html;
        });
      }
    }

    function handleUserSearch() {
      const query = searchInput.value.trim();
      if (!query) {
        resultsDiv.innerHTML = '';
        noResultsDiv.classList.add('hidden');
        return;
      }
      performActualSearch(query);
    }

    searchBtn.addEventListener('click', handleUserSearch);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleUserSearch();
      }
    });

    // === é¡µé¢åŠ è½½ ===
    window.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>
</body>
</html>
