<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Doujiao</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    .search-btn {
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 0.5rem;
    }
    .search-btn:hover { background-color: #2563eb; }
    .disabled-input { background-color: #f9fafb; color: #9ca3af; cursor: not-allowed; }
    .disabled-btn { background-color: #d1d5db; cursor: not-allowed; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen py-12 px-4">
  <!-- è®¿é—®ç æ¨¡æ€æ¡† -->
  <div id="accessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
      <h2 class="text-xl font-bold text-gray-800 text-center mb-4">ğŸ”’ è·å–ä»Šæ—¥è®¿é—®æƒé™</h2>
      <p class="text-gray-600 text-center mb-6">è¯·å‰å¾€æŒ‡å®šä½ç½®è·å–ä»Šæ—¥è®¿é—®ç ï¼š</p>
      <a href="https://your-link-to-get-code.com" target="_blank" rel="noopener noreferrer"
         class="w-full block text-center py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition mb-6">
        ğŸ‘‰ ç‚¹å‡»è·å–ä»Šæ—¥è®¿é—®ç 
      </a>
      <input id="accessCodeInput" type="text" placeholder="ä¾‹å¦‚: ab12" maxlength="4"
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 mb-4" />
      <button id="verifyBtn" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition">éªŒè¯è®¿é—®ç </button>
      <p id="errorText" class="text-red-500 text-sm mt-4 text-center hidden"></p>
    </div>
  </div>

  <!-- æœç´¢è§†å›¾ -->
  <div id="mainContainer" class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ğŸ” Doujiao</h1>
    <div id="typeNav" class="text-center mt-4 hidden"></div>
    <div class="flex flex-col md:flex-row gap-2 items-center justify-center mt-4">
      <input id="searchInput" type="text" placeholder="è¯·å…ˆéªŒè¯è®¿é—®ç ..." disabled
             class="w-full md:w-96 px-4 py-3 border border-gray-300 rounded-lg shadow-sm disabled-input" />
      <button class="search-btn disabled-btn" disabled>æœç´¢</button>
    </div>
    <div id="loading" class="text-center text-gray-500 mt-6 hidden">æ­£åœ¨åŠ è½½èµ„æºåº“...</div>
    <div id="results" class="mt-6 space-y-4"></div>
    <div id="noResults" class="text-center text-gray-500 mt-8 hidden">æœªæ‰¾åˆ°ç›¸å…³èµ„æº ğŸ˜¢</div>
  </div>

  <!-- æ¸…å•è§†å›¾ -->
  <div id="listView" class="max-w-4xl mx-auto hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 id="listTitle" class="text-2xl font-bold text-gray-800"></h2>
      <button id="backBtn" class="text-blue-500 hover:underline">â† è¿”å›</button>
    </div>
    <div id="groupedList" class="space-y-6"></div>
    <div id="listPagination" class="mt-8 flex justify-center space-x-2"></div>
  </div>

  <script>
    // === é…ç½® ===
    const STOP_WORDS = ['å°è¯´', 'ç”µè§†', 'å®Œç»“', 'å…¨é›†', 'å®Œæ•´ç‰ˆ', 'é«˜æ¸…', 'ä¸­æ–‡'];
    const MAIN_CANDIDATES = ['wukong','quark','baidu','uc','xunlei','kuaitu','mobile','uc_lanzou','baidu_zip','mobile_zip','xunlei_zip'];
    const BACKUP_CODE_CANDIDATES = ['wukong_m','quark_m','baidu_m','ucm','xunlei_m','kuaitu_m','mobile_m'];
    const ACCESS_CODES = { '2025-12-28': 'ab12' }; // æŒ‰éœ€æ‰©å±•

    // DOM ç¼“å­˜
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const searchInput = $('#searchInput');
    const mainContainer = $('#mainContainer');
    const listView = $('#listView');

    let resources = [], verified = false, currentListType = null;
    const ITEMS_PER_PAGE = 20;

    // === å·¥å…·å‡½æ•° ===
    const getRandomNonEmptyLink = (item, fields) =>
      fields.map(f => item[f]).filter(url => url?.trim()?.startsWith('http'))[Math.floor(Math.random() * fields.length)] || null;

    const cleanQuery = q => STOP_WORDS.reduce((s, w) => s.replace(new RegExp(w, 'g'), ''), q).trim();

    const toggleLoading = show => $('#loading').classList.toggle('hidden', !show);

    // === è§†å›¾åˆ‡æ¢ ===
    const switchView = to => {
      mainContainer.classList.toggle('hidden', to === 'list');
      listView.classList.toggle('hidden', to === 'search');
    };

    // === æ¸²æŸ“å•ä¸ªèµ„æºé¡¹ ===
    const renderResourceItem = (item, inList = false) => {
      const main = getRandomNonEmptyLink(item, MAIN_CANDIDATES);
      const backup = item.lanzou?.startsWith('http') ? item.lanzou : null;
      const codeLink = getRandomNonEmptyLink(item, BACKUP_CODE_CANDIDATES);
      let html = `<h4 class="font-semibold text-blue-600">${item.title}</h4>`;
      if (main) html += `<a href="${main}" target="_blank" class="block mt-1 text-green-600">ğŸ”— ${inList ? 'ä¸»ç½‘ç›˜' : 'ç½‘ç›˜'}</a>`;
      if ((backup || codeLink) && !inList) html += '<div class="border-t border-gray-200 my-2"></div>';
      if (backup) html += `<a href="${backup}" target="_blank" class="block mt-1 text-orange-600">ğŸ”— å¤‡ç”¨ç½‘ç›˜</a>`;
      if (codeLink) html += `<a href="${codeLink}" target="_blank" class="block mt-1 text-purple-600">ğŸ”‘ ${inList ? 'æå–ç ' : 'å¤‡ç”¨ç½‘ç›˜æå–ç '}</a>`;
      return `<div class="bg-white p-4 rounded-lg shadow">${html}</div>`;
    };

    // === åŠ è½½æ•°æ® & æ¸²æŸ“ç±»å‹å¯¼èˆª ===
    const loadData = () => {
      toggleLoading(true);
      fetch(`./data.json?t=${Date.now()}`)
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
          resources = data;
          toggleLoading(false);
          const types = [...new Set(resources.map(i => i.type).filter(t => t))];
          $('#typeNav').innerHTML = types.length
            ? `<div class="flex flex-wrap justify-center gap-2">${
                types.map(t => `<button data-type="${t}" class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg">${t}</button>`).join('')
              }</div>`
            : '';
          $('#typeNav').classList.toggle('hidden', types.length === 0);
          $('#typeNav').onclick = e => {
            if (e.target.matches('button[data-type]')) {
              currentListType = e.target.dataset.type;
              $('#listTitle').textContent = `${currentListType}æ¸…å•`;
              switchView('list');
              renderListPage(1);
            }
          };
        })
        .catch(() => $('#loading').innerHTML = '<p class="text-red-500 text-center">âŒ åŠ è½½å¤±è´¥</p>');
    };

    // === æ¸…å•åˆ†é¡µæ¸²æŸ“ ===
    const renderListPage = page => {
      const items = resources.filter(i => i.type === currentListType);
      const groups = items.reduce((acc, i) => {
        const key = (i.initial || '#').toUpperCase();
        (acc[key] = acc[key] || []).push(i);
        return acc;
      }, {});
      const initials = Object.keys(groups).sort();
      const all = initials.flatMap(k => [{type:'header',k}, ...groups[k].map(d=>({type:'item',d}))]);
      const total = Math.ceil(all.length / ITEMS_PER_PAGE);
      const start = (page - 1) * ITEMS_PER_PAGE;
      const pageItems = all.slice(start, start + ITEMS_PER_PAGE);

      $('#groupedList').innerHTML = pageItems.length
        ? pageItems.map(e => e.type === 'header'
            ? `<h3 class="text-xl font-bold text-gray-700 border-l-4 border-blue-500 pl-2">${e.k}</h3>`
            : renderResourceItem(e.d, true)
          ).join('')
        : '<p class="text-center text-gray-500">æš‚æ— èµ„æº</p>';

      // åˆ†é¡µæ§ä»¶
      const pg = $('#listPagination');
      if (total <= 1) return void pg.classList.add('hidden');
      pg.classList.remove('hidden');
      const delta = 2, range = [];
      for (let i = Math.max(1, page - delta); i <= Math.min(total, page + delta); i++) range.push(i);
      if (range[0] !== 1) { range.unshift('...'); range.unshift(1); }
      if (range[range.length - 1] !== total) { range.push('...'); range.push(total); }
      pg.innerHTML = `
        ${page > 1 ? `<button data-page="${page - 1}" class="px-3 py-1 border rounded">â®</button>` : ''}
        ${range.map(p => p === '...' ? `<span class="px-2">â‹¯</span>` : 
           p == page ? `<span class="px-3 py-1 bg-blue-500 text-white rounded">${p}</span>` :
                      `<button data-page="${p}" class="px-3 py-1 border rounded">${p}</button>`).join('')}
        ${page < total ? `<button data-page="${page + 1}" class="px-3 py-1 border rounded">â¯</button>` : ''}
      `;
      pg.onclick = e => {
        if (e.target.matches('button[data-page]')) {
          renderListPage(+e.target.dataset.page);
        }
      };
    };

    // === æœç´¢é€»è¾‘ ===
    const performSearch = ((func, wait) => {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => func(...args), wait); };
    })((rawQuery) => {
      const container = $('#results'), noRes = $('#noResults');
      if (!verified || !resources || !rawQuery.trim()) return (container.innerHTML = '', noRes.classList.add('hidden'));
      const query = cleanQuery(rawQuery);
      if (!query) return (container.innerHTML = '<p class="text-gray-500 text-center">è¯·è¾“å…¥æœ‰æ•ˆå…³é”®è¯</p>', noRes.classList.add('hidden'));
      const hits = resources.filter(i => (i.title || '').toLowerCase().replace(/\s/g, '').includes(query.toLowerCase().replace(/\s/g, '')));
      container.innerHTML = hits.map(renderResourceItem).join('');
      noRes.classList.toggle('hidden', hits.length > 0);
    }, 300);

    // === åˆå§‹åŒ– & äº‹ä»¶ç»‘å®š ===
    $('#verifyBtn').addEventListener('click', () => {
      const input = $('#accessCodeInput').value.trim();
      const today = new Date().toISOString().split('T')[0];
      const expected = ACCESS_CODES[today];
      if (!expected) return ($('#errorText').textContent = `ç³»ç»Ÿé”™è¯¯ï¼šæœªé…ç½® ${today} çš„è®¿é—®ç ã€‚`, $('#errorText').classList.remove('hidden'));
      if (input === expected) {
        localStorage.setItem('lastVerifiedDate', today);
        $('#accessModal').classList.add('hidden');
        searchInput.disabled = false;
        searchInput.placeholder = "è¾“å…¥èµ„æºåç§°...";
        searchInput.classList.remove('disabled-input');
        $('.search-btn').disabled = false;
        $('.search-btn').classList.remove('disabled-btn');
        verified = true;
        loadData();
      } else {
        $('#errorText').textContent = 'è®¿é—®ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚';
        $('#errorText').classList.remove('hidden');
      }
    });

    $('#backBtn').addEventListener('click', () => switchView('search'));

    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      if (localStorage.getItem('lastVerifiedDate') === today) {
        verified = true;
        searchInput.disabled = false;
        searchInput.placeholder = "è¾“å…¥èµ„æºåç§°...";
        searchInput.classList.remove('disabled-input');
        $('.search-btn').disabled = false;
        $('.search-btn').classList.remove('disabled-btn');
        loadData();
      } else {
        $('#accessModal').classList.remove('hidden');
      }
    });

    searchInput.addEventListener('input', e => performSearch(e.target.value));
    $('.search-btn').addEventListener('click', () => performSearch(searchInput.value));
    searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') performSearch(searchInput.value); });
  </script>
</body>
</html>
